/**
 * Using adaptive Gauss-Kronrod Quadrature to evaluate the integral of f(x) over a finite domain.
**/

#ifndef GAUSS_KRONROD_H
#define GAUSS_KRONROD_H

#include "GaussLegendre.h"

class GaussKronrodBase : public GaussLegendreBase{
    // Dummy class to store the nodes and weights
    public:
    virtual ~GaussKronrodBase() = default;

    // Weights associated with the Gauss-Legendre nodes used in Gauss-Kronrod routines.
    inline static const std::vector<Eigen::ArrayXd> _Lweights =
        {{{0.8888888888888889}}, // starting at n = 1
         {{0.4909090909090909, 0.4909090909090909}},
         {{0.2684880898683338, 0.4509165386584746, 0.2684880898683338}},
         {{0.1700536053357231, 0.3269491896014521, 0.3269491896014521, 0.1700536053357231}},
         {{0.1152333166224727, 0.2410403392286477, 0.2829874178574913, 0.2410403392286477, 0.1152333166224727}}, // n = 5
         {{0.0836944404469058, 0.1810719943231379, 0.2337708641169940, 0.2337708641169940, 0.1810719943231379, 0.0836944404469058}},
         {{0.0630920926299783, 0.1406532597155260, 0.1903505780647856, 0.2094821410847274, 0.1903505780647856, 0.1406532597155260, 0.0630920926299783}},
         {{0.0494393950021392, 0.1116463708268402, 0.1566526061681888, 0.1814000250680342, 0.1814000250680342, 0.1566526061681888, 0.1116463708268402, 0.0494393950021392}},
         {{0.0396318951602617, 0.0907906816887264, 0.1300014068553415, 0.1564135277884832, 0.1648960128283498, 0.1564135277884832, 0.1300014068553415, 0.0907906816887264, 0.0396318951602617}},
         {{0.0325581623079644, 0.0750396748109197, 0.1093871588022977, 0.1347092173114738, 0.1477391049013377, 0.1477391049013377, 0.1347092173114738, 0.1093871588022977, 0.0750396748109197, 0.0325581623079644}}
        }; // n = 10 is the highest order

    // Extra Gauss-Kronrod nodes
    inline static const std::vector<Eigen::ArrayXd> _Knodes =
        {{{-0.7745966692414833,  0.7745966692414833}}, // starting at n = 1
         {{-0.9258200997725514,  0.0000000000000000,  0.9258200997725514}},
         {{-0.9604912687080204, -0.4342437493468024,  0.4342437493468024,  0.9604912687080204}},
         {{-0.9765602507375734, -0.6402862174963099,  0.0000000000000000,  0.6402862174963099,  0.9765602507375734}},
         {{-0.9840853600948420, -0.7541667265708494, -0.2796304131617834,  0.2796304131617834,  0.7541667265708494,  0.9840853600948420}}, // n = 5
         {{-0.9887032026126785, -0.8213733408650278, -0.4631182124753047,  0.0000000000000000,  0.4631182124753047,  0.8213733408650278,  0.9887032026126785}},
         {{-0.9914553711208126, -0.8648644233597690, -0.5860872354676913, -0.2077849550078988,  0.2077849550078988,  0.5860872354676913,  0.8648644233597690,  0.9914553711208126}},
         {{-0.9933798758817167, -0.8941209068474565, -0.6723540709451583, -0.3607010979281319,  0.0000000000000000,  0.3607010979281319,  0.6723540709451583,  0.8941209068474565,  0.9933798758817167}},
         {{-0.9946781606773405, -0.9149635072496780, -0.7344867651839337, -0.4754624791124598, -0.1642235636149869,  0.1642235636149869,  0.4754624791124598,  0.7344867651839337,  0.9149635072496780,  0.9946781606773405}},
         {{-0.9956571630258079, -0.9301574913557080, -0.7808177265864168, -0.5627571346686048, -0.2943928627014604,  0.0000000000000000,  0.2943928627014604,  0.5627571346686048,  0.7808177265864168,  0.9301574913557080,  0.9956571630258079}}
        }; // n = 10 is the highest order

    // Weights associated with the extra Gauss-Kronrod nodes
    inline static const std::vector<Eigen::ArrayXd> _Kweights =
        {{{0.5555555555555556, 0.5555555555555556}}, // starting at n = 1
         {{0.1979797979797980, 0.6222222222222222, 0.1979797979797980}},
         {{0.1046562260264674, 0.4013974147759618, 0.4013974147759618, 0.1046562260264674}},
         {{0.0629773736654729, 0.2667983404522846, 0.3464429818901361, 0.2667983404522846, 0.0629773736654729}}, 
         {{0.0425820367510821, 0.1868007965564924, 0.2728498019125588, 0.2728498019125588, 0.1868007965564924, 0.0425820367510821}}, // n = 5
         {{0.0303961541198201, 0.1373206046344471, 0.2132096522719623, 0.2410725801734653, 0.2132096522719623, 0.1373206046344471, 0.0303961541198201}},
         {{0.0229353220105295, 0.1047900103222504, 0.1690047266392678, 0.2044329400752993, 0.2044329400752993, 0.1690047266392678, 0.1047900103222504, 0.0229353220105295}},
         {{0.0178223833207102, 0.0824822989313582, 0.1362631092551723, 0.1720706085552109, 0.1844464057446914, 0.1720706085552109, 0.1362631092551723, 0.0824822989313582, 0.0178223833207102}},
         {{0.0143047756438387, 0.0665181559402740, 0.1117891346844181, 0.1452395883843660, 0.1628628274401153, 0.1628628274401153, 0.1452395883843660, 0.1117891346844181, 0.0665181559402740, 0.0143047756438387}},
         {{0.0116946388673721, 0.0547558965743521, 0.0931254545836974, 0.1234919762620657, 0.1427759385770600, 0.1494455540029175, 0.1427759385770600, 0.1234919762620657, 0.0931254545836974, 0.0547558965743521, 0.0116946388673721}}
        }; // n = 10 is the highest order
};

template<int N = 1, int M = 1>
class GaussKronrod : public GaussianQuadrature<N, M>, GaussKronrodBase{
    public:
    using typename Quadrature<N, M>::DomainType;
    using typename Quadrature<N, M>::RangeType;
    using typename Quadrature<N, M>::Function;
    using typename Quadrature<N, M>::IFunc1D;
    using typename Quadrature<N, M>::IFuncMD;
    using typename Quadrature<N, M>::IntegrationBound;
    using typename Quadrature<N, M>::IntegrationDomain;

    GaussKronrod(std::size_t n, double tol=1e-6): GaussianQuadrature<N, M>(n), GaussKronrodBase(), _tol(tol)
    {
        if (n < 1 || n > 10) throw std::domain_error("Error: Can only support 1 through 10 integration nodes.");
    }

    RangeType integrate(const Function& f, const IntegrationDomain& D) const override;
    protected:
    double _tol;

    std::size_t n() const noexcept override{ return 2*this->_n+1; }
    Eigen::VectorXd getNodes(double l, double u) const override;
    Eigen::VectorXd getWeights(double l, double u) const override;

    double error(const RangeType& GL, const RangeType& GK) const noexcept;

    IntegrationBound midpoint(const IntegrationBound& l, const IntegrationBound& u) const;
    void recursiveSplitDomain(std::vector<IntegrationDomain>& newDomains, const IntegrationDomain& oldDomain,
                              const std::vector<IntegrationBound>& midpoints, std::size_t d, std::size_t start, std::size_t stop) const noexcept;
    RangeType adaptiveIntegral(const Function& f, const IntegrationDomain& D, double tol, std::size_t d) const;
};

#include "GaussKronrod.tpp"
#endif